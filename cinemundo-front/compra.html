<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMundo - Finalizar Compra</title>
    <link rel="stylesheet" href="css/compra.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div class="stars"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>

    <div id="modal-drama" class="modal-drama-overlay" style="display: none;">
        <div class="modal-drama-content">
            <i class="fas fa-skull-crossbones" style="font-size: 50px; color: red; margin-bottom: 20px;"></i>
            <h2>TEMPO ESGOTADO!</h2>
            <p>‚ö†Ô∏è Voc√™ demorou mais de 15 minutos.</p>
            <p>O sistema cedeu os seus ingressos para outra pessoa.</p>
            <button onclick="window.location.href='principal.html'" class="btn-drama">Voltar ao In√≠cio</button>
        </div>
    </div>

    <header>
        <a href="principal.html" class="tiulo">CineMundo</a>
        <nav>
            <ul>
                <li><a href="principal.html">In√≠cio</a></li>
                <li><a href="principal.html#filmes-em-cartaz">Filmes</a></li>
                <li><a href="login.html" id="btn-nav-login" class="btn-login">Login</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="compra-container">
            <h2>üéüÔ∏è Garantir Ingresso</h2>
            <p class="subtitulo">Confirme os dados para gerar seu pagamento.</p>

            <form class="form-compra" id="form-finalizar">
                
                <div class="grupo-input">
                    <label for="filme-select">Filme Selecionado:</label>
                    <div class="input-icon">
                        <i class="fas fa-film"></i>
                        <select id="filme-select" required>
                            <option value="" disabled selected>Selecione um filme...</option>
                            <option value="O Auto da Compadecida 2">O Auto da Compadecida 2</option>
                            <option value="Bailarina - John Wick">Bailarina - John Wick</option>
                            <option value="Ainda Estou Aqui">Ainda Estou Aqui</option>
                            <option value="Capit√£o Am√©rica: Admir√°vel Mundo Novo">Capit√£o Am√©rica: Admir√°vel Mundo Novo</option>
                            <option value="A Garota Dinamarquesa">A Garota Dinamarquesa</option>
                            <option value="Segundo Tempo">Segundo Tempo</option>
                            <option value="Sharknado">Sharknado</option>
                            <option value="O Menino e a Gar√ßa">O Menino e a Gar√ßa</option>
                        </select>
                    </div>
                </div>

                <div class="grupo-input">
                    <label for="nome">Nome Completo:</label>
                    <div class="input-icon">
                        <i class="fas fa-user"></i>
                        <input type="text" id="nome" placeholder="O seu nome" required>
                    </div>
                </div>

                <div class="linha-dupla">
                    <div class="grupo-input">
                        <label for="cpf">CPF (Para Nota):</label>
                        <div class="input-icon">
                            <i class="fas fa-id-card"></i>
                            <input type="text" id="cpf" placeholder="000.000.000-00" required>
                        </div>
                    </div>

                    <div class="grupo-input">
                        <label for="email">Email (Confirma√ß√£o):</label>
                        <div class="input-icon">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="email" readonly required style="background: #222; color: #777;">
                        </div>
                    </div>
                </div>

                <div class="pagamento-section">
                    <label>Forma de Pagamento:</label>
                    <div class="opcoes-pagamento">
                        
                        <label class="opcao-card">
                            <input type="radio" name="pagamento" value="cartao" required>
                            <div class="card-content">
                                <i class="fas fa-credit-card"></i>
                                <span>Cart√£o</span>
                            </div>
                        </label>

                        <label class="opcao-card">
                            <input type="radio" name="pagamento" value="pix">
                            <div class="card-content">
                                <i class="fab fa-pix"></i> <span>PIX</span>
                            </div>
                        </label>

                    </div>
                </div>

                <button type="submit" class="btn-finalizar">Confirmar Compra</button>

            </form>
        </div>
    </main>

    <footer class="footer-real">
        <p>¬© 2025 CineMundo - Todos os direitos reservados.</p>
    </footer>

    <script>
        // 1. VERIFICA√á√ÉO DE SEGURAN√áA E PREENCHIMENTO AUTOM√ÅTICO
        document.addEventListener("DOMContentLoaded", () => {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            const filmeSelecionado = localStorage.getItem('filmeSelecionado');

            // Se n√£o tiver login, manda embora
            if (!usuario) {
                alert("Voc√™ precisa fazer login para comprar!");
                window.location.href = "login.html";
                return;
            }

            // Preencher dados do usu√°rio automaticamente
            document.getElementById('nome').value = usuario.nome || "";
            document.getElementById('email').value = usuario.email || "";
            document.getElementById('btn-nav-login').innerText = "Ol√°, " + usuario.nome.split(' ')[0];

            // Tentar selecionar o filme automaticamente se veio do carrinho
            if (filmeSelecionado) {
                const select = document.getElementById('filme-select');
                // Procura a op√ß√£o que tem o texto igual ao salvo
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].text === filmeSelecionado || select.options[i].value === filmeSelecionado) {
                        select.selectedIndex = i;
                        break;
                    }
                }
            }
        });

        // 2. ENVIO DO FORMUL√ÅRIO (INTEGRA√á√ÉO API)
        document.getElementById('form-finalizar').addEventListener('submit', async (e) => {
            e.preventDefault();

            const usuario = JSON.parse(localStorage.getItem('usuario'));
            const filme = document.getElementById('filme-select').value;
            const metodoPagamento = document.querySelector('input[name="pagamento"]:checked').value;
            const cpf = document.getElementById('cpf').value;

            const dadosCompra = {
                nome: usuario.nome,
                email: usuario.email,
                cpf: cpf,
                valor: 35.00, // Valor fixo simb√≥lico
                descricao: "Ingresso: " + filme,
                metodoPagamento: metodoPagamento
            };

            try {
                // Chama a API que criamos
                const response = await fetch('http://localhost:3000/api/comprar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosCompra)
                });

                const data = await response.json();

                if (metodoPagamento === 'pix') {
                    alert("C√≥digo PIX Gerado (Copiado para √°rea de transfer√™ncia):\n\n" + data.pixCode);
                    navigator.clipboard.writeText(data.pixCode); // Copia autom√°tico
                } else {
                    alert("Processando cart√£o... (Simula√ß√£o enviada ao servidor)");
                }

                alert("Compra 'efetuada'! Verifique o Console do Servidor para ver o email enviado.");
                
                // 3. L√ìGICA DO DRAMA (15 MINUTOS)
                iniciarContagemDrama();

            } catch (error) {
                console.error(error);
                alert("Erro ao conectar com o servidor.");
            }
        });

        // Fun√ß√£o Dram√°tica
        function iniciarContagemDrama() {
            console.log("Contagem regressiva de 15 minutos iniciada...");
            
            // 15 minutos = 900000ms. 
            // Para TESTE R√ÅPIDO, mude para 5000 (5 segundos). Para o real, use 900000.
            setTimeout(() => {
                document.getElementById('modal-drama').style.display = 'flex';
            }, 15 * 60 * 1000); // 15 minutos reais
        }
    </script>
</body>
</html>